"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var iPerceptions=iPerceptions||{};iPerceptions.ipEngine={url:"//ips-invite.iperceptions.com/wUniversal.aspx?sdfc=095904e8-{0}-fb330c52-9ae4-4a44-a31d-b80f2c680ca0&lID={1}&source=91787&visitorID=[ipe_v]&sessionID=[ipe_s]&device=[device]",device:"",culture:"",langId:0,pageViewed:0,launch:function(ipDef,dv,ct,visit){"use strict";var wrapper=iPerceptions.Wrapper,i,j,invites,invite,trigger,rate,expires,visitorId=visit.visitors[visit.visitors.length-1].id;try{this.device=dv.toLowerCase();this.culture=ct;var validDomains=!1,domains=JSON.parse(ipDef.Domains),theDomain=location.host,noWildCards;for(i=0;i<domains.length;i+=1)if(noWildCards=domains[i].substring(1),theDomain===domains[i]){validDomains=!0;break}else if("*."===domains[i].substring(0,2)&&-1!==theDomain.indexOf(noWildCards,theDomain.length-noWildCards.length)){validDomains=!0;break}if(!validDomains)return;for(this.pageViewed=wrapper.getPageViewed(),invites=ipDef.Invites,i=0;i<invites.length;i+=1)invite=invites[i],invite.CustomScript&&invite.CustomScript.length>0&&eval(invite.CustomScript),invite.ProjectInviteTriggers=this.shuffleObject(invite.ProjectInviteTriggers),-10===invite.TemplateId&&this.evaluateInvite(invite)&&wrapper.injectJs("Iperceptions_"+invite.ProjectId.toString(),invite.CommentCardUrl,null,function(){var n={langID:langId};ipeCC[0].ipeIcon(n)});invites=this.reinvite(invites,visit.history);invites=wrapper.getIframeSessionStorage(iPerceptions.Wrapper.getInvitesKey(),invites)}catch(e){}},displayInvite:function(n,t,i,r,u,f,e){var c,l,s,o,h,v=iPerceptions.Wrapper,y=u.visitors[u.visitors.length-1].id,a;for(n=this.shuffleObject(n),c=0;c<n.length;c+=1)for(s=n[c],l=0;l<s.ProjectInviteTriggers.length;l+=1)if(o=s.ProjectInviteTriggers[l],null!=e){if(a=e.split(","),s.ProjectId==a[0]&&o.Id==a[1]){this.injectInvite(s,o,y,f,i,u,h);return}}else if(this.evaluateTrigger(o)===!0){console.log("Trigger being evaluated : "+o.Id+" trigger languageId : "+o.LanguageId);("tablet"===i||"mobile"===i)&&(console.log("Tablet or mobile device detected"),v.setIframeSessionStorage(this.getMobileIconKey(),s.ProjectId+","+o.Id));this.injectInvite(s,o,y,f,i,u,h);return}h=new Date;h.setFullYear(h.getFullYear()+1);v.updateVisit(u,h)},injectInvite:function(n,t,i,r,u,f,e){var o=iPerceptions.Wrapper,s=o.getCookie("IPE_DISP_"+n.ProjectId),h=o.getCookie("IPE_M_"+n.ProjectId);return void o.injectJs("Iperceptions_invite",this.url.replace("{0}",n.ProjectId).replace("{1}",t.LanguageId).replace("[ipe_v]",i).replace("[ipe_s]",r).replace("[device]",u),null,function(){("1"!==s||"1"!==h)&&(e=iPerceptions.ipEngine.setreinvite(n,f.history),iPerceptions.Wrapper.updateVisit(f,e))})},reinvite:function(n,t){for(var o,r,u=[],s=[],e=new Date,h,c,f,i=0;i<n.length;i+=1){if(h=iPerceptions.Wrapper.getCookie("IPE_DISP_"+n[i].ProjectId),c=iPerceptions.Wrapper.getCookie("IPE_M_"+n[i].ProjectId),"1"===h&&"1"===c)return s.push(n[i]),s;-10!=n[i].TemplateId&&u.push(n[i])}for(e.setYear(e.getYear()-1),i=0;i<t.length;i+=1){for(f=null,r=new Date(t[i].date),e=r>e?r:e,o=0;o<u.length&&null===f;o+=1)u[o].ProjectId===t[i].id&&(f=o);null!==f&&void 0!==f&&(r.setDate(r.getDate()+n[f].ReInviteProject),r>new Date&&u.splice(f,1))}for(i=0;i<u.length;i+=1)r=new Date(this.getString(e)),r.setDate(r.getDate()+u[i].ReInviteOtherProject),(r<=new Date||"1"===h&&"1"===c)&&s.push(u[i]);return s},setreinvite:function(n,t){var f,i,u,r=new Date,e=null;for(u=r,f=this.getString(r),i=0;i<t.length;i+=1)t[i].id===n.ProjectId&&(e=i),r=new Date(t[i].date),r.setDate(r.getDate()+t[i].ReInviteProject),u=r>u?r:u;return null!==e?t[e].date=f:t.push({id:n.ProjectId,date:f,host:location.host}),u},evaluateRate:function(n,t,i,r,u,f,e,o){var y=iPerceptions.Wrapper,a=[],s,l,h,c,v;for(t=(void 0!=t||null!=t)&&t.length>0?JSON.parse(t):[],t instanceof Array||(t=[]),s=[],l=0;l<n.length;l++){for(h=n[l],c=[],j=0;j<h.ProjectInviteTriggers.length;j+=1)(trigger=h.ProjectInviteTriggers[j],2!==trigger.InviteTypeId)&&(-1===t.indexOf(trigger.Id)?0===t.length&&(rate="tablet"===this.device?trigger.TabletRate:"mobile"===this.device?trigger.MobileRate:trigger.DesktopRate,v=100*Math.random(),v<rate&&(s.push(trigger.Id),c.push(trigger))):c.push(trigger));c.length>0&&(h.ProjectInviteTriggers=c,a.push(h))}0==s.length&&(s=t);y.setInvites(JSON.stringify(s));this.getIpeStorage(a,i,r,u,f,e,o)},getString:function(n){return n.getFullYear()+"/"+(n.getMonth()+1)+"/"+n.getDate()},shuffleObject:function(n){for(var i,r,t=n.length-1;t>=0;t-=1)Math.random()<.5&&(i=Math.floor(Math.random()*t),r=n[t],n[t]=n[i],n[i]=r);return n},evaluateInvite:function(n){for(var t=0;t<n.ProjectInviteTriggers.length;t+=1)if(this.evaluateTrigger(n.ProjectInviteTriggers[t])===!0)return langId=n.ProjectInviteTriggers[t].LanguageId,!0;return!1},evaluateTrigger:function(n){for(var t=n.ProjectInviteTriggerConditions[0],r=this.evaluateCondition(t),i=1;i<n.ProjectInviteTriggerConditions.length;i+=1)t=n.ProjectInviteTriggerConditions[i],r=t.IsAnd===!0?r&&this.evaluateCondition(t):r||this.evaluateCondition(t);return r},evaluateCondition:function(n){try{switch(n.ConditionTypeId){case 1:return this.evaluateOperation(n.ConditionOperationId,this.culture.toString(),n.Value);case 2:var t=location.href.toLowerCase();return(3===n.ConditionOperationId||6===n.ConditionOperationId)&&0===n.Value.toLowerCase().indexOf("www")&&(t=location.href.replace(/^https?:\/\//,"")),this.evaluateOperation(n.ConditionOperationId,t,n.Value.toLowerCase());case 3:return this.evaluateOperation(n.ConditionOperationId,this.getQueryParam(n.Parameter),n.Value);case 4:return this.evaluateOperation(n.ConditionOperationId,iPerceptions.Wrapper.getCookie(n.Parameter),n.Value);case 5:return this.evaluateTrigger(n.CompanyInviteRule);case 6:return this.evaluateOperation(n.ConditionOperationId,this.pageViewed.toString(),n.Value);case 7:return this.evaluateOperation(n.ConditionOperationId,this.device.toLowerCase(),n.Value.toLowerCase());case 8:return this.evaluateCustomCondition(n.Value)}}catch(i){}},evaluateOperation:function(n,t,i){if(n>0&&11>n&&void 0===t)return!1;t=t.trim();i=i.trim();try{switch(n){case 1:return t===i;case 2:return t!==i;case 3:return 0===t.indexOf(i.toString());case 4:return-1!==t.indexOf(i.toString());case 5:return-1===t.indexOf(i.toString());case 6:return t.toString()===i.toString();case 7:return i.length>0&&t.substring(t.length-i.length,t.length)===i;case 8:return parseInt(t)<parseInt(i);case 9:return parseInt(t)>parseInt(i);case 10:return""!==t;case 11:return""===t;case 12:return this.getDevice(parseInt(i));case 13:return!this.getDevice(parseInt(i));case 14:return""===t;case 15:return""!==t}}catch(r){}},evaluateCustomCondition:function(n){if(void 0===n&&0==n.length)return!1;try{return new Function(n)()}catch(t){}return!1},getQueryParam:function(n){for(var t,i,u=location.search.substring(1).split("&"),r=0;r<u.length;r+=1)i=u[r].split("="),i[0]===n&&(void 0===t?t=i[1]:"string"==typeof t?t=[t,i[1]]:t.push(i[1]));return t instanceof Array?t.join():t},getDevice:function(n){return 1===n&&"desktop"===this.device||3===n&&"tablet"===this.device||2===n&&"mobile"===this.device},toJson:function(){var n,t={};for(n in this)this.hasOwnProperty(n)&&(t[n]="function"==typeof this[n]?this[n].toString():this[n]);return JSON.stringify(t)},getIpeStorage:function(n,t,i,r,u,f){var e=iPerceptions.Wrapper,o=document.getElementById(e.frameId).contentWindow;o.postMessage(JSON.stringify({key:this.getMobileIconKey(),method:"getsessionMob"}),"*");e.addEvent("message",function(e){var o,s;e.origin.indexOf(iPerceptions.Wrapper.iFrameUrl)>=0&&(o=JSON.parse(e.data),"universalgetsessionMob"==o.source&&(s=o.value,iPerceptions.ipEngine.displayInvite(n,t,i,r,u,f,s)))},!1)},getMainDomain:function(n){var t=n.substring(n.indexOf("://")+3);return t.split("/")[0].split(":")[0]},getMobileIconKey:function(){var n=!1,t=iPerceptions.Wrapper;return typeof ipDef=="object"&&typeof ipDef.CheckMobileDomain!="undefined"&&(n=ipDef.CheckMobileDomain),n?"IPE_WM_"+t.companyId+"_"+this.getMainDomain(window.location.href):"IPE_WM_"+t.companyId}};
